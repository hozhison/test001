//域名
var serverUrl = "http://proxy.tintop.cn:22880";
//代理商ID
var disId = "1535699156425002";
var bg = chrome.extension.getBackgroundPage();
var find=function(t){return document.querySelector(t)},
sendMessage=chrome.tabs.sendMessage,
onMessage=chrome.runtime.onMessage,
query=chrome.tabs.query,
container=find("#container"),
showAddBtn=find("#showAddBtn"),
checkStatusBtn=find("#checkStatusBtn"),
addArea=find(".add-area"),
cancelBtn=find("#cancelBtn"),
confirmBtn=find("#confirmBtn"),
accountBtnArea=find("#accountBtnArea"),
accountNameInput=find("#accountName"),
accountInput=find("#account"),
passwordInput=find("#password"),
Plugin={
	initButton:function(){
		var t=this,n="",e={};
		if(JSON.stringify(localStorage)=="{}"){
			bg.stopCheck();
		}
		for(var a in localStorage)localStorage.hasOwnProperty(a)&&(n=t.getStorage(a),e=JSON.parse(n),e.account,e.password,t.createButton(a),t.showCheck(),t.syncCheckStatus())
	},
	bindEvent:function(){
		var t=this;
		accountBtnArea.addEventListener("click",function(n)
		{
			n.stopPropagation();
			var e=n.target,a=n.target.className,o="",c={};
			"account-btn"===a?(o=e.parentNode.getAttribute("storage-key"),c=JSON.parse(t.getStorage(o)),t.fillTheBlank(c.account,c.password)):"fa fa-trash"===a?(o=e.parentNode.parentNode.getAttribute("storage-key"),t.removeStorage(o),location.reload()):console.log("neither account-btn nor delete-btn.")
		},!1),
		
		showAddBtn.addEventListener("click",function(){addArea.style.display="block",showAddBtn.style.display="none"},!1),
		
		cancelBtn.addEventListener("click",function(){
			location.reload()
		},!1),
		
		checkStatusBtn.addEventListener("click",function(){
			bg.changestatus(); // 访问bg的函数
			t.syncCheckStatus();
		},!1),
		
		confirmBtn.addEventListener("click",function()
		{
			var n=accountNameInput.value,e=accountInput.value,a=passwordInput.value;
			if(""===n||""===e||""===a)return void console.info("input incomplete.");
			var loginStatus = t.checkLogin(e,a);
			console.log("loginStatus" + loginStatus);
			if(loginStatus){
				var o={account:e,password:a},c=JSON.stringify(o);
				t.setStorage(n,c),t.clearInput(),location.reload()
			}else{
				alert("登录失败，账号或密码错误，请重试");
			}
			// var o={account:e,password:a},c=JSON.stringify(o);
			// t.setStorage(n,c),t.clearInput(),location.reload()
		},!1)
	},
	syncCheckStatus:function(){
		if(bg.check){
			checkStatusBtn.innerText = "自动审核中···";
		}else{
			checkStatusBtn.innerText = "开始自动审核";
		}
	},
	checkLogin:function(username, password){
		//httpPost
		var result;
		var xhr = new XMLHttpRequest();
		var postData = {"applicationId":"1","distributorId":disId,"noCode":true};
		postData.username = username;
		postData.password = password;
		xhr.open("POST", serverUrl + "/ums/pub/user/login", false);
		xhr.setRequestHeader("Content-type", "application/json");
		//json数据转化为字符串
		xhr.send(JSON.stringify(postData));
		// xhr.onreadystatechange = function() {
			// if (xhr.readyState == 4) {
				// if (xhr.status == 200) {
					// result = JSON.parse(xhr.responseText);
					// alert(JSON.stringify(result));
				// }
			// }
		// };
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
				result = JSON.parse(xhr.responseText);
				if(result.success){
					chrome.storage.local.set({'accessToken': result.content.access_token,'refreshToken':result.content.refresh_token}, function() {
						console.log('存储accessToken成功');      
					});
					bg.setAccessToken(result.content.access_token,result.content.refresh_token);
				}
				return result.success;
			}
		}
		return false;
	},
	showCheck:function(){checkStatusBtn.style.display="block",showAddBtn.style.display="none"},
	showPanel:function(){addArea.style.display="block",showAddBtn.style.display="none"},
	hidePanel:function(){addArea.style.display="none",showAddBtn.style.display="block"},
	setStorage:function(t,n){localStorage.setItem(t,n)},
	getStorage:function(t){return localStorage.getItem(t)},
	removeStorage:function(t){localStorage.removeItem(t)},
	clearInput:function(){accountNameInput.value="",accountInput.value="",passwordInput.value=""},
	createButton:function(t,n,e)
	{
		var a=document.createElement("div");
		a.className="button-row",a.setAttribute("storage-key",t);
		var o=document.createElement("button");
		o.className="account-btn",o.innerText=t;
		var c=document.createElement("div");
		c.className="icon-container";
		var r=document.createElement("i");
		r.className="fa fa-trash",c.appendChild(r),a.appendChild(o),a.appendChild(c),accountBtnArea.appendChild(a)
	},
	fillTheBlank:function(t,n)
	{
		query({active:!0,currentWindow:!0},function(e){sendMessage(e[0].id,{action:"FILL_THE_BLANK",account:t,password:n},function(t){console.log(t)})})
	},
	init:function(){this.initButton(),this.bindEvent()}
};
Plugin.init();
